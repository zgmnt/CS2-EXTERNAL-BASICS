using System;
using System.Numerics;
using Swed64;

Swed swed = new Swed("cs2");
IntPtr client = swed.GetModuleBase("client.dll");

int dwEntityList = 0x19A3328;
int m_hPlayerPawn = 0x7DC; // from CCS PlayerController
int m_iHealth = 0x324; // from CCS PlayerController

int m_iszPlayerName = 0x630; // from C BasePlayerController
int m_vecLastClipCameraPos = 0x12D4;
int m_iTeamNum = 0x3C3;
string teamSTR = "";
string MYteamSTR = "";
double diff = 0;


float posX = 0;
float posY = 0;
float posZ = 0;

float myPosX = 0;
float myPosY = 0;

int[] kitchenX = { -1493, -1572, -2364, -2360 };
int[] kitchenY = { -334, -728, -700, -243 };

int[] ticketX = {-1442 , -1355, - 1000, -768};
int[] ticketY = {-2571, - 2140, - 2134, -2712};

static bool IsPointInPolygon(float x, float y, int[] polyX, int[] polyY)
{
    int n = polyX.Length;
    bool inside = false;

    for (int i = 0, j = n - 1; i < n; j = i++)
    {
        if (((polyY[i] > y) != (polyY[j] > y)) &&
            (x < (polyX[j] - polyX[i]) * (y - polyY[i]) / (polyY[j] - polyY[i]) + polyX[i]))
        {
            inside = !inside;
        }
    }

    return inside;
}


static string DetermineFigure(float x, float y, int[] figure1X, int[] figure1Y, int[] figure2X, int[] figure2Y)
{
    bool isInFigure1 = IsPointInPolygon(x, y, figure1X, figure1Y);
    bool isInFigure2 = IsPointInPolygon(x, y, figure2X, figure2Y);

    switch ((isInFigure1, isInFigure2))
    {
        case (true, false):
            return "ticket";
        case (false, true):
            return "kitchen";
        default:
            return "inna";
    }
}

while (true)
{
    IntPtr t_entityList = swed.ReadPointer(client, dwEntityList);
    IntPtr entityList = swed.ReadPointer(t_entityList, 0x10);

    for (int i = 0; i < 64; i++)
    {
        if (entityList == IntPtr.Zero)
            continue;

        // zyskujemy poczatek pamieci iteracji graczy
        IntPtr currentControler = swed.ReadPointer(entityList, i * 0x78);

        if (currentControler == IntPtr.Zero)
            continue;

        int pawnHandle = swed.ReadInt(currentControler, m_hPlayerPawn);

        if (pawnHandle == 0)
            continue;

        // second
        IntPtr listEntry2 = swed.ReadPointer(t_entityList, 0x8 * ((pawnHandle & 0x7FFF) >> 9) + 0x10);
        IntPtr currentPawn = swed.ReadPointer(listEntry2, 0x78 * (pawnHandle & 0x1FF));

        // values
        string name = swed.ReadString(currentControler, m_iszPlayerName, 16);
        int i_name = swed.ReadInt(currentControler, m_iszPlayerName);
        uint health = swed.ReadUInt(currentPawn, m_iHealth);

        // testy
        posX = swed.ReadVec(currentPawn, m_vecLastClipCameraPos)[0];
        posY = swed.ReadVec(currentPawn, m_vecLastClipCameraPos)[1];
        posZ = swed.ReadVec(currentPawn, m_vecLastClipCameraPos)[2];
        int team = swed.ReadInt(currentPawn, m_iTeamNum);

        if (team == 2)
        {
            teamSTR = "TT";
        }
        else
        {
            teamSTR = "CT";
        }

        if (i_name == 1330074435)
        {
            myPosX = posX;
            myPosY = posY;
            MYteamSTR = teamSTR;
        }

        //diff = Math.Sqrt((myPosX - posX) * (myPosX - posX) + (myPosY - posY) * (myPosY - posY)) / 50;
        // pamietaj zeby to zmieniac int i_name = swed.ReadInt(currentControler, m_iszPlayerName);


        if (team == 3)
        {
            if (health > 0)

            {

                string pozycja = DetermineFigure(posX, posY, ticketX, ticketY, kitchenX, kitchenY);

                
                if (diff <25)
                {
                    Console.ForegroundColor = ConsoleColor.DarkRed;
                }
                else
                {
                    Console.ForegroundColor = ConsoleColor.Green;
                }

                Console.ForegroundColor = ConsoleColor.Green;
                Console.WriteLine($"{teamSTR} {name} {pozycja}");
                
            }

        }


    }

    System.Threading.Thread.Sleep(1000);
    Console.Clear();
}
